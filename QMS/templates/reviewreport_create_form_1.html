{% extends 'master.html' %}
{% load static from staticfiles %}

{% block siteTitle %}QMS{% endblock %}
{% block pageTitle %}QMS{% endblock %}
{% block content  %}


<link href="/static/plugins/dataTables/css/dataTables.bootstrap.css" rel="stylesheet" type="text/css">
{{form.media}}

<div class="row">


    <div class="col-sm-12">


        <div class="panel widget">
            <div class="panel-heading vd_bg-grey">

                <h3 class="panel-title"><span class="menu-icon"> <i class="fa fa-magic"></i> </span> QA Sheet </h3>
                {% for dict in formset.errors %}
                {% for error in dict.values %}
                {{ error }}
                {% endfor %}
                {% endfor %}
                {% if messages %}
                {% for message in messages %}
                {% if message.tags %}
                <div class="alert alert-{{ message.tags }}">
                    <a class="panel-close close" data-dismiss="alert">x</a>
                    <p>{{ message }}</p>
                </div>
                {% endif %}
                {% endfor %}
                {% endif %}

            </div>
            <div class="panel-body table-responsive">
                <form class="form-horizontal " id="filter_form" role="form" method="post">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-sm-12 qms-selectors">

                                <span>{{ form.project.errors }}</span>{{ form.project}}
                                <span>{{ form.qms_process_model.errors }}</span>{{ form.qms_process_model}}

                                <span>{{ form.template.errors }} </span>{{form.template}}

                                <!-- <span>{{form.review_group.errors}}</span>{{form.review_group}} -->


                                <span>{{ form.chapter.errors }} </span>{{form.chapter}}
                            <span>{{ form.component.errors }} </span>{{form.component}}


                                <span>{{form.author.errors}}</span>{{form.author}}




                        </div>

                    </div><!-- ./qms-selectors row -->
                    <hr>


                    <div class="row">
                        <div class="col-sm-12 qms-allocators" style="display:none">

                          <div class="form-group">
                            <div class="col-md-12">
                              <label class="control-label col-sm-2 field-name"><span>Field 1</span><span class="vd_red"> *</span></label>
                              <div class="controls col-sm-6">
                                <select type="select" class="width-50 input-sm select-name" name="name" >
                                    <option>Option 1</option>
                                    <option>Option 2</option>
                                    <option>Option 3</option>
                                    <option>Option 4</option>
                                    <option>Option 5</option>
                                </select>
                              </div>
                            </div>
                          </div>



                        </div>
                    </div>

                    <hr>

                    <div class="row">

                        <div class="col-sm-12 qms-add-field" style="display:none">
                            <div class="col-sm-2 controls">
                                <select id="select-field" type="select" class="input-sm" >
                                    <option>Add Field 1</option>
                                    <option>Add Field 2</option>
                                    <option>Add Field 3</option>
                                    <option>Add Field 4</option>
                                </select>
                            </div>
                            <div class="col-sm-10">
                                <button id="qms-add-field" class="btn btn-primary btn-sm">Add This Field</button>
                            </div>
                        </div>

                    </div>


                    <div class="row submit" style="display:none">
                        <div class="col-sm-12">
                            <input type="submit" class="btn btn-danger btn-sm pull-right" value="Submit">
                        </div>
                    </div>


                </form>


                <br>


            </div><!-- ./panel body -->

        </div>


    </div>

</div><!-- ./row main -->


<script type="text/javascript" src="/static/plugins/dataTables/jquery.dataTables.min.js"></script>

<script type="text/javascript">

// Get the html for .form-group
var domObj = $('.qms-allocators').html();

// Clear the existing html in .form-group
var clearDom = function(){
    $('.form-group').remove();
}

//
 function populateNames(theObj){

    $('.qms-allocators select').html('');

    for (var key in theObj['team_members']) {
      if (theObj['team_members'].hasOwnProperty(key)) {

        // changes all the select boxes simultaneously
        $('.qms-allocators select').append("<option value="+ key +">" + theObj['team_members'][key] + "</option>");
        $('.qms-allocators,.qms-add-field ,.submit').show();
      }
    }
}

function array_flip( trans )
{
    var key, tmp_ar = {};

    for ( key in trans )
    {
        if ( trans.hasOwnProperty( key ) )
        {
            tmp_ar[trans[key]] = key;
        }
    }

    return tmp_ar;
}


// Main function : populating the DOM
function populateForm (theObj){

    var i = 0 ;
    clearDom();


theObj['tab_name'] = array_flip(theObj['tab_name'])

    for (var key in theObj['tab_name']) { 


      if (theObj['tab_name'].hasOwnProperty(key)) {     // opening object

        if (theObj['tabs'][theObj['tab_name'][key]] == true) {
            $('.qms-allocators').append(domObj);
           $('.qms-allocators .form-group:last-child select').attr('name',  "user_"+key);

            $('.qms-allocators .form-group:last-child .field-name span:first-child').html(theObj['tab_name'][key]);

            populateNames(theObj);

        }else{
            $('select#select-field').html('');
            $('select#select-field').append("<option name=" + key + " >" + theObj['tab_name'][key] + "</option>");
        }

      }
    }
}



<!--var something = {-->
    <!--'tabs': {'Editor Review 2': False, 'Editor Review 3': True, 'Editor Review 1': True}, -->
    <!--'tab_name': {'Editor Review 2': 2, 'Editor Review 3': 3, 'Editor Review 1': 1}, -->
    <!--'team_members': {256: 'SumukhShamnur', 257: 'KanakaPrakash', 254: 'Bhaviya', 255: 'RaviKumar'}, -->
    <!--'user_tab': {'Editor Review 2': None, 'Editor Review 3': None, 'Editor Review 1': 476}-->
<!--}-->










$(document).ready(function(){

   $(':input[name$=chapter]').on('change', function()  {
        if($(':input[name$=component]').val()!='') {
            $(':input[name$=component]').trigger('change');
         }
    });

    $(':input[name$=author]').on('change', function()  {
        if($(this).val() !='') {
              $.ajax({
                url: '/qms/get_template_process_review/',
                type: 'GET',
                dataType :'json',
                data: {"template_id": $(':input[name$=template]').val() , "project_id" :  $(':input[name$=project]').val() ,"qms_process_model" :$(':input[name$=qms_process_model]').val(),"chapter" :$(':input[name$=chapter]').val(),"author" :$(':input[name$=author]').val() },
                success: function (data) {
                console.log("author");
                    console.log(data);
                    populateForm(data);
                },

            });
        }
    });
$(':input[name$=component]').change(function(){
    $.ajax({
            url: '/qms/fetch_author/',
            type: 'GET',
            dataType :'json',
            data: {"project_id" :  $(':input[name$=project]').val() , "component_id" :  $(this).val() ,"chapter_id" :  $(':input[name$=chapter]').val() },
            beforeSend : function(data) { $(':input[name$=author]').empty() ; $('.select-name ').empty() ;},
            success: function (data) {
            console.log("component");console.log(data);
                for (var key in data) {
                    if (data.hasOwnProperty(key)) {

                        if(key == 'team_members'){
                            $(':input[name$=author]').append($('<option>', {
                                    value: "",
                                    text: "-------",
                                }));
                            for (var k in data[key]){
                                $(':input[name$=author]').append($('<option>', {
                                    value: k,
                                    text: data['team_members'][k],
                                }));
                            }
                        }
                    }

                }
                    console.log(typeof(data['author'] ) +'--'+ data['author']);
                if(data['author'] != 'None' || data['author'] != '' ) { console.log("if cond");
                    $('#id_author option[value='+data['author']+']').prop("selected", true);
                }
                else if (data['author'] == 'None'){ console.log("im in else if");

                                 $('#id_author option[value=""]').prop("selected", true);
                }else{console.log("else");}

            },
            complete: function (data) { $(':input[name$=author]').trigger('change');}

    });
});

    $('#qms-add-field').click(function(e){
        e.preventDefault();
        optCount = $('#select-field > option').length; // The bug
        console.log('the number of options is ' + optCount);


        if (optCount > 1) {

            theField = $('#select-field').val();
            theID = $('#select-field option:selected').attr('name');
            $('#select-field option:selected').remove();
            console.log('the selected value is ' + theField);

            theClone = $('.qms-allocators .form-group:first-child').clone().appendTo('.qms-allocators');
            $('.qms-allocators .form-group:last-child').find('.field-name span:first-child').html(theField);
            $('.qms-allocators .form-group:last-child').find('select').attr('name', 'user_'+theID);

        }else if (optCount == 1) {
            console.log('option count is none');
            theField = $('#select-field').val();
            theID = $('#select-field option:selected').attr('name');
            $('#select-field option:selected').remove();
            console.log('the selected value is ' + theField);

            theClone = $('.qms-allocators .form-group:first-child').clone().appendTo('.qms-allocators');
            $('.qms-allocators .form-group:last-child').find('.field-name span:first-child').html(theField);
            $('.qms-allocators .form-group:last-child').find('select').attr('name','user_'+theID);

            $('#select-field').html('The end');
            $('#qms-add-field').prop('disabled', true);

        }
    })


    // Function Calls







})//./doc.ready    

</script>




<style type="text/css">

    .btn.pull-right{margin-left: 15px}

    .qms-selectors .form-inline{margin-right: 30px;}

    .edit-buttons{width: 65px;}
    .gradeX a.vd_btn{margin-right: 0px !important;}

    .select2.select2-container {min-width: 0px !important;width: 150px !important;margin-right: 10px;}
    .author_dropdown {
        min-width: 0px !important;
        width: 150px !important;
        margin-right: 15px;
        border: 1px solid #aaaaaa;
        border-radius: 4px;
        position: relative;
        top: 1px;
        /* color: #999; */
    }
    .table-striped>tbody>tr:nth-of-type(odd) {
    background-color: #f3f1f1;
    }
    .qa-editable{cursor: pointer;}
    .qa-table td p{margin-bottom: 0px; line-height: 30px;}

    #qms-summary{
    border-top: 1px solid #aaa;
    border-bottom: 1px solid #aaa;
    padding: 15px 0px;
    margin-bottom: 15px;
    transition: all 0.5s ease;
    }
    #qms-summary.collapsed{height: 0px;overflow: hidden;padding: 0px;border-bottom: 0px;}

    #qms-summary table, #qms-summary table td, #qms-summary table th{border:1px solid #d6d6d6;text-align: center;}

    #review_report_form{position:relative}
    #review_report_form td input[type="text"], #review_report_form td select{height:25px}
    .no_questions{
    position: absolute;
    top: -55px;
    right: 15px;
    }
    .table .menu-action{padding-top:7px !important;}
</style>


{% endblock %}