
{% extends 'master.html' %}
{% block siteTitle %}Manage Leaves{% endblock %}

{% load bootstrap3 %}
{% load fontawesome %}
{% load static from staticfiles %}
{% block pageTitle %}All Leaves{% endblock %}


{% block content  %}
    <link href="/static/css/leave_style.css" rel="stylesheet">
	<link href="/static/bootstrap3_datetime/css/bootstrap-datetimepicker.min.css" type="text/css" media="all" rel="stylesheet" />
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" />

{% load grievances_template_tags %}{% load permissions %}


    <div class="container Lv-themeTxtColor ">
        <!--  Start Leave details popup-->

                <div class="modal fade" id="modal-container-252304" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header vd_bg-blue vd_white">

                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
								x
							</button>
                                <h4 class="modal-title" id="myModalLabel">Leave Details</h4>
                            </div>
                            <div class="modal-body">

                            </div>
                            <div class="modal-footer">

                                <button type="button" class="btn btn-danger" data-dismiss="modal">
								Close
							</button>
                                <!--<button type="button" class="btn btn-primary">-->
								<!--Save changes-->
							<!--</button>-->
                            </div>
                        </div>

                    </div>

                </div>


        <!--  End Leave details pop-->

        <!--      My Leaves Start -->
<style type="text/css">
  
.table-condensed>thead>tr>th, .table-condensed>tbody>tr>th, .table-condensed>tfoot>tr>th, .table-condensed>thead>tr>td, .table-condensed>tbody>tr>td, .table-condensed>tfoot>tr>td {
    padding: 5px 8px;
}
  
</style>

        <!--	Start Menu -->
        <div class="row">
            <div class="col-md-12">
                <div class="Lv-ApLvHeader">



                  <!-- Start content	-->
                  <form class="form-horizontal " id="filter_form" role="form" method="post" >
                  <div class="row margin-top11">
                      {% csrf_token %}
                      <div class="col-md-12 col-sm-6 ">

                              <div class="form-group form-inline short-date mb-0">
                                  <label for="from_date">From :&nbsp;</label>
                                  {{form.from_date}}
                                  <label for="to_date">To :&nbsp;</label>
                                  {{form.to_date}}
                                  <select class="form-control filter_class input-sm" id="application_status" name="application_status">

                                    <option value ="all">All</option>
                                      {% for value, text in APPLICATION_STATUS %}
                                          {% if value != 'applied' %}
                                              <option value="{{value}}" {%if post_application_status|safe == value|safe %} selected {% endif %} >{{text}}</option>
                                          {% endif %}
                                      {%endfor%}


                                  </select>&nbsp;&nbsp;&nbsp;&nbsp;
                                  {% if request.user|has_group:"myansrsourceHR"  or request.user.is_superuser%}
                                      <select class="form-control filter_class input-sm" id="apply_to" name="apply_to">
                                          <option value="" selected >Applied To</option>
                                           {% for managers in apply_to %}
                                              <option value="{{managers.1}}" {%if post_apply_to|safe == managers.1|safe %} selected {% endif %}>{{managers.0}}</option>
                                          {% endfor %}
                                      </select>
                                  {%endif%}
                                  <select class="form-control filter_class input-sm" id="users" name="users">
                                      <option value="" selected >Applied By</option>
                                       {% for employee in users %}
                                          <option value="{{employee.user.id}}"{%if post_users|safe == employee.user.id|safe %} selected {% endif %} >{{employee.user.username}}</option>
                                      {% endfor %}
                                  </select>
                                  <div class="export-btn">

                                  <input type="submit" id="submit_button" class="btn btn-primary btn-sm btn-ansr-orange" value ="Search" name="filter"/>
                                  <input type="reset" id="reset_button" class="btn btn-danger btn-sm btn-ansr-orange" value ="Reset" name="cancel"/>
                                  </div>


                                      {%if leave_list%}

                                      <div class="pull-right export-btn-2">



                                                  <input type="submit" class="pull-right btn btn-sm btn-danger btn-ansr-orange" value = "Export" name="export"/>



                                                 <b style="line-height:30px;">Total : {{leave_list|length}} &nbsp;&nbsp;&nbsp;</b>
                                              </div>
                                      {% endif %}




                              </div>





                      </div>

                      <div class="col-md-1 col-sm-6">
          <!--                <div class="pull-right ">
                              <input type="submit" class="pull-right btn btn-xs btn-danger" value = "Export" name="export"/>
                          </div>-->



                      </div>
                  </div>


                  </form>





                </div><!-- end of Lv-ApLvHeader -->
                <hr>

            </div>
        </div>
        <!-- End Menu -->


        {% if leave_list %} <div class="row">
            <div class="col-md-12">

                <table class="table table-bordered table-hover ansrgreen">
                    <tr class="Lv-ApproveTH ">
                        <th>Employee</th>
                        <th>Type</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Applied To</th>
                        <th>Days</th>
                        <th style="width:30%">Status
                        </th>
                    </tr>
                    {% for leave in leave_list %}

                    <tr  {%for k,v in  BUTTON_NAME %}
                                {%if v|safe == leave.status|safe %} class ="info" {%endif%}{%endfor%}>
                        <td>
                            <a id="modal-252334" href="#modal-container-252304" role="button" data-toggle="modal" class ="list_view mod" title="View Details">{{leave.user.first_name}} {{leave.user.last_name}}</a>
                            <div class="GrDetails" style = "display:none" >
                         <table class="table  table-hover view_details"  >
                                 <tr >
                                     <td >Applied By : </td>
                                     <td>{{leave.user.first_name}} {{leave.user.last_name}}</td>
                                 </tr>
                                 <tr>
                                     <td>Applied On: </td>
                                     <td>{{leave.applied_on}}</td>
                                 </tr>
                                 <tr >
                                     <td>Leave Type : </td>
                                     <td>{%for k,v in LEAVE_TYPES_CHOICES %}{%if leave.leave_type|safe == k  %}{{v.strip}}{% endif %}{% endfor %}</td>
                                 </tr>



                                 <tr >
                                     <td>From: </td>
                                     <td>{{leave.from_date}} ,{%for k,v in  SESSION_STATUS %} {%if k == leave.from_session %} {{v}} {% endif %}{%endfor%}</td>
                                 </tr>
                                 <tr >
                                     <td>To: </td>
                                     <td>{{leave.to_date}} , {%for k,v in  SESSION_STATUS %} {%if k == leave.to_session %} {{v}} {% endif %} {%endfor%} </td>
                                 </tr>
                                 <tr >
                                     <td>No Of Days: </td>
                                     <td>{%for k,v in leave_days.iteritems%}{%if k|safe == leave.id|safe%} {{v}} {%endif%}{%endfor%}</td>
                                 </tr>
                                 <tr >
                                     <td>Reason: </td>
                                     <td>{{leave.reason}}</td>
                                 </tr>
                                 <tr >
                                     <td>Manager: </td>
                                     <td>{{leave.apply_to.first_name}} {{leave.apply_to.last_name}}</td>
                                 </tr>
                             <tr >
                                     <td>Status: </td>
                                     <td>{{leave.status|title}}</td>
                                 </tr>
                                 <tr >
                                         <td>Status Action On: </td>
                                         <td>{{leave.status_action_on}}</td>
                                     </tr>
                                     <tr >
                                             <td>Status Action By: </td>
                                             <td>{{leave.status_action_by.first_name}} {{leave.status_action_by.last_name}}</td>
                                         </tr>
                                 <tr >
                                     <td></td>
                                     <td>
                                         <div>
                                           {% if leave.atachement%} <p><strong>Attachment:</strong></p>
      <div class="" >
      <!-- Attachments start -->
                <a target="_blank" href="{{leave.atachement.url}}">
                    {% if leave.atachement.name|GetFileTypeFromName == 'xls' or leave.atachement.name|GetFileTypeFromName == 'xlsx' %}
                        <img alt="An XLS file" src="/static/images/file_type_icons/xls_icon.png" height="50px" width="50px">
                    {% elif leave.atachement.name|GetFileTypeFromName == 'csv' %}
                        <img alt="A csv file" src="/static/images/file_type_icons/csv_icon.png" height="50px" width="50px">
                    {% elif leave.atachement.name|GetFileTypeFromName == 'pdf' %}
                        <img alt="A pdf file" src="/static/images/file_type_icons/pdf_icon.png" height="50px" width="50px">
                    {% elif leave.atachement.name|GetFileTypeFromName == 'doc' or leave.atachement.name|GetFileTypeFromName == 'docx'  %}
                        <img alt="A doc file" src="/static/images/file_type_icons/doc_icon.png" height="50px" width="50px">
                    {% elif leave.atachement.name|GetFileTypeFromName == 'jpg' or leave.atachement.name|GetFileTypeFromName == 'jpeg' or leave.atachement.name|GetFileTypeFromName == 'png' %}
                        <img alt="A doc file" src="{{leave.atachement.url }}" height="50px" width="50px">

                    {% endif %}
                </a>
              </div>
        {% endif %}
         <!-- Attachments end -->
                                         </div>
                                     </td>
                                 </tr>

                             </table></div>
                        </td>
                        <td>{%for k,v in LEAVE_TYPES_CHOICES %}{%if leave.leave_type|safe == k  %}{{v.strip}}{% endif %}{% endfor %}</td>
                        <td>{{leave.from_date}},<br> {%for k,v in  SESSION_STATUS %} {%if k == leave.from_session %} {{v}} {% endif %}{%endfor%} </td>
                        <td>{{leave.to_date}},<br>{%for k,v in  SESSION_STATUS %} {%if k == leave.to_session %} {{v}} {% endif %} {%endfor%} </td>

                        <td>{{leave.apply_to.first_name}} {{leave.apply_to.last_name}} </td>
                        <td>{%for k,v in leave_days.iteritems%}{%if k|safe == leave.id|safe%} {{v}} {%endif%}{%endfor%}</td>

                        <td>
                           {%for k,v in  BUTTON_NAME %}
                                {%if v|safe == leave.status|safe %}
                                    <label class="btn-xs btn-{{k}}" >{{v|title}}</label>

                                {%endif%}
                            {%endfor%}

                            {% if leave.status_comments %}
                                    <br><span> Reason : {{leave.status_comments}}</span>
                            {% endif %}
                        </td>
                    </tr>{%endfor%}

                </table>

            </div>

        </div> {% endif %}


	{%if not leave_list %}
	  <div class="row ">
            <div class="col-md-12">
                <table class="table table-bordered table-hover Lv-RecordsNotFound">
                    <tr class="info">
                        <th class="text-center">No leave applications found</th>
                    </tr>
                </table>

            </div>

        </div>
    {% endif %}

        <!-- End content-->
<div class="text-center">{%if  leave_list %} <div class="pagination">
    <span class="step-links">
        {% if leave_list.has_previous %}
            <a href="?page={{ leave_list.previous_page_number }}">previous</a>
        {% endif %}

        <span class="current">
            Page {{ leave_list.number }} of {{ leave_list.paginator.num_pages }}.
        </span>

        {% if leave_list.has_next %}
            <a href="?page={{ leave_list.next_page_number }}">next</a>
        {% endif %}
    </span>
</div> </div>{% endif %}
    </div>
    <!-- End Main Container-->
{% endblock  %}

 {% block page_specific_JS %}
	<script type="text/javascript" src="/static/bootstrap3_datetime/js/moment.min.js"></script>
	<script type="text/javascript" src="/static/bootstrap3_datetime/js/bootstrap-datetimepicker.min.js"></script>
    <script src="/static/js/date_validation.js"></script>
    <script>
    $(document).ready( function (){

            var url = window.location.href ;
            url = url.split('/');

            if(url[4] == 'leavelist' && (url[5] == '' || url[5].indexOf("?page") >= 0 )) {
                window.history.replaceState( {} , 'Leave List', '/leave/leavelist/' );
            }
            else if(url[4] == 'leavelist' && url[5] == 'all' && ( url[6] == '' ||  url[6] != '') ) {
                window.history.replaceState( {} , 'Leave List', '/leave/leavelist/all' );
            }

            $('input[type="checkbox"]').on('change', function() {
                $('input[type="checkbox"]').not(this).prop('checked', false);
            });

            $('.list_view').click(function(){
                var GrDetails = $(this).siblings(".GrDetails").html();
                $(".modal-body").html(GrDetails);
            });

            $('input[name="export"]').on('click', function() {
                $( "#filter_form" ).submit();
            });

    });
    var dtCh= "/";
    var d = new Date();
    var n = d.getFullYear();
    var minYear=n;
    var maxYear=n;

    function isCustomDate(dtStr) {
    var daysInMonth = DaysArray(12)
    var pos1 = dtStr.indexOf(dtCh)
    var pos2 = dtStr.indexOf(dtCh, pos1 + 1)
    var strDay = dtStr.substring(0, pos1)
    var strMonth = dtStr.substring(pos1 + 1, pos2)
    var strYear = dtStr.substring(pos2 + 1)
    strYr = strYear
    if (strDay.charAt(0) == "0" && strDay.length > 1) strDay = strDay.substring(1)
    if (strMonth.charAt(0) == "0" && strMonth.length > 1) strMonth = strMonth.substring(1)
    for (var i = 1; i <= 3; i++) {
        if (strYr.charAt(0) == "0" && strYr.length > 1) strYr = strYr.substring(1)
    }
    month = parseInt(strMonth)
    day = parseInt(strDay)
    year = parseInt(strYr)
    if (pos1 == -1 || pos2 == -1) {
        alert("The date format should be : dd/mm/yyyy")
        return false
    }
    if (strMonth.length < 1 || month < 1 || month > 12) {
        alert("Please enter a valid month")
        return false
    }
    if (strDay.length < 1 || day < 1 || day > 31 || (month == 2 && day > daysInFebruary(year)) || day > daysInMonth[month]) {
        alert("Please enter a valid day")
        return false
    }
    if (dtStr.indexOf(dtCh, pos2 + 1) != -1 || isInteger(stripCharsInBag(dtStr, dtCh)) == false) {
        alert("Please enter a valid date")
        return false
    }
    return true
}
    function custom_date_validation(from, to) {
    var is_different = false;
    if ($('#' + from).val() != "" || $('#' + to).val() != "") {

        var frm_check_index = $('#' + from).val().indexOf("/");
        if (frm_check_index != -1) {
            var frm_date = $('#' + from).val().split("/");
        } else {
            var frm_date = $('#' + from).val().split("-");
            is_different = true;
        }

        converted_frm_date = new Date(frm_date[0], frm_date[1], frm_date[2]);

        var to_check_index = $('#' + to).val().indexOf("/");
        if (to_check_index != -1) {
            var id_closure_date = $('#' + to).val().split("/");
            converted_id_closure_date = new Date(id_closure_date[0], id_closure_date[1], id_closure_date[2]);
        } else {
            var id_closure_date = $('#' + to).val().split("-");
            converted_id_closure_date = new Date(id_closure_date[0], id_closure_date[1], id_closure_date[2]);
        }
        if (converted_frm_date > converted_id_closure_date) {
            alert("From date Cannot Be Greater Than To Date ");
            return false
        }
        var from_date = $('#' + from).val();
        var to_date = $('#' + to).val()

        if (is_different) {
            from_date = $('#' + from).val().split('-');
            from_date = from_date[2] + '/' + from_date[1] + '/' + from_date[0];
            to_date = $('#' + to).val().split('-');
            to_date = to_date[2] + '/' + to_date[1] + '/' + to_date[0];
        }

        if (isCustomDate(from_date) == false || isCustomDate(to_date) == false) {
            alert("Please Enter The Valid Date ");
            return false
        }
    }
    return true
}
    $('#submit_button').click(function(){
              var result  =  custom_date_validation('id_from_date','id_to_date');
              if (result === false) return false;

             var inputs = input_elements_validation('filter_class', 'leave/leavelist');
             if (inputs === false) return false;

        });
    </script>
{%endblock%}
