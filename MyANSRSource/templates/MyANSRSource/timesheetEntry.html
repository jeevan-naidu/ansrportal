{% extends 'timesheetMaster.inc'  %}

{% load bootstrap3 %}
{% block startDate %}
{{ weekstartDate }}
{% endblock %}

{% block endDate %}
{{ weekendDate }}
{% endblock %}
{% block container %}"container container-timesheet" {% endblock %}
{% block timesheetContent %}
  <form id="timesheet" method="post" action="" enctype="multipart/form-data">
	{% csrf_token %}
    <div id="timesheet-billable">
	<legend>
	Project Effort 
	<span class="pull-right">
		<a type="submit" value="submit" class="btn btn-success btn-xs" id="timesheet-billable-add-btn">
			<span class="glyphicon glyphicon-plus"></span>
			Add Project effort Item
		</a>
	</span>
	</legend>

    {{ tsFormset.management_form }}
	{% for eachError in tsErrorList %}
		{% if eachError.items|length > 0 %}
			<div class="alert alert-danger" role="alert">
				{% for k, v in eachError.items %}
					{{ k }} : {{ v|striptags }}
				{% endfor %}
			</div>
		{% endif %}
	{% endfor %}
	<table class="table table-condensed table-responsive">
	{% for form in tsFormset %}
		{{ form.errors }}
		{% if forloop.first %}
		<thead>
		<tr>
			<td colspan="4" class="text-right"><h5></small><b>Swipe Card Hours</b></small></h5></td>
			<td class="text-center"><b>0</b></td>
			<td class="text-center"><b>0</b></td>
			<td class="text-center"><b>0</b></td>
			<td class="text-center"><b>0</b></td>
			<td class="text-center"><b>0</b></td>
			<td class="text-center"><b>0</b></td>
			<td class="text-center"><b>0</b></td>
		</tr>
            	<tr>
			{% for field in form.hidden_fields %}
				{% if 'id' in field.label %}
					<td style="display: none">{{ field.label }}</td>
				{% endif %}
			{% endfor %}
			{% for data in form.visible_fields %}
				{% if 'Questions' not in data.label and 'Hours' not in data.label and 'id' not in data.label and 'approved' not in data.label and 'hold' not in data.label %}
				{% if forloop.counter == 1 or forloop.counter == 2 or forloop.counter == 3 or forloop.counter == 4 %}
					<th class="res-14-per">
				{% else %}
					<th>
				{% endif %}
				{% if 'Chapter' in data.label %}
					Chapter/Subtitle
				{% else %}
				{{ data.label }}
				{% endif %}
				{% if data.field.required %}
					<span class="required">*</span>
				{% endif %}
					</th>
				{% endif %}
			{% endfor %}
            	</tr>
		</thead>
		<tbody>
		{% endif %}
		<tr>
			{% for field in form.hidden_fields %}
				{% if 'id' in field.label %}
					<td style="display: none">{{ field }}</td>
				{% endif %}
				{% if 'pt' in field.label %}
					<td style="display: none">{{ field }}</td>
				{% endif %}
			{% endfor %}
			{% for data in form.visible_fields %}
			{% spaceless %}
			{% if data.label in shortDays %}
					<td>
						{% for data in form.visible_fields %}
							{% if 'hold' in data.label %}
								{% if data.value %}
									<a class="btn btn-default day-popover-button disabled" href="javascript:;">
								{% else %}
									<a class="btn btn-default day-popover-button" href="javascript:;">
								{% endif %}
							{% endif %}
						{% endfor %}
							{% for tdata in form.hidden_fields %}
								{% if data.label|lower in tdata.id_for_label and 'Q' in tdata.id_for_label %}
									{% for typeData in form.hidden_fields %}
										{% if 'projectType' in typeData.id_for_label %}
											{% if tdata.value > 0 %}
												<span class="b-questions">{{ tdata.value }}</span>
												<span class="project-unit">{{ typeData.value }}</span>
											{% else %}
												<span class="b-questions">0</span> 
												{% if typeData.value == None %}
													<span class="project-unit">Q</span>
												{% else %}
													<span class="project-unit">{{ typeData.value }}</span>
												{% endif %}
											{% endif %}
										{% endif %}
									{% endfor %}
									{{ tdata }}
								{% endif %}
							{% endfor %}
							-
							{% for tdata in form.hidden_fields %}
								{% if data.label|lower in tdata.id_for_label and 'H' in tdata.id_for_label %}
									{% if tdata.value > 0 %}
										<span class="b-hours">{{ tdata.value }}</span>H
									{% else %}
										<span class="b-hours">0</span>H
									{% endif %}
									{{ tdata }}
								{% endif %}
							{% endfor %}
						</a>
					</td>
				{% elif data.label == 'Total' %}
					<td>
						{% for data in form.visible_fields %}
							{% if 'hold' in data.label %}
								{% if data.value %}
									<a class="btn btn-default row-total-view disabled" href="javascript:;">
								{% else %}
									<a class="btn btn-default row-total-view" href="javascript:;">
								{% endif %}
							{% endif %}
						{% endfor %}
							{% for data in form.hidden_fields %}
								{% if 'totalQ' in data.id_for_label %}
									{% for typeData in form.hidden_fields %}
										{% if 'projectType' in typeData.id_for_label %}
										{% if data.value > 0 %}
											<span class="t-questions">{{ data.value }}</span>
											<span class="project-unit">{{ typeData.value }}</span>
										{% else %}
											<span class="t-questions">0</span>
											{% if typeData.value == None %}
												<span class="project-unit">Q</span>
											{% else %}
												<span class="project-unit">{{ typeData.value }}</span>
											{% endif %}
										{% endif %}
										{% endif %}
									{% endfor %}
									{{ data }}
								{% endif %}
							{% endfor %}
							-
							{% for data in form.hidden_fields %}

								{% if 'totalH' in data.id_for_label %}
								    {% for Ndata in form %}
									{% if Ndata.label == 'Task' %}
									    {% if Ndata.value == 'I' %}
										 {% if data.value > 0 %}
										    <input type="hidden" class="r-total-idle-hours" value="{{ data.value }}" />
										    <input type="hidden" class="r-total-billable-hours" value="0" />
										 {% else %}
										    <input type="hidden" class="r-total-idle-hours" value="0" />
										 {% endif %}
									    {% else %}
										 {% if data.value > 0 %}
										    <input type="hidden" class="r-total-billable-hours" value="{{ data.value }}" />
										    <input type="hidden" class="r-total-idle-hours" value="0" />
										 {% else %}
										    <input type="hidden" class="r-total-billable-hours" value="0" />
										    <input type="hidden" class="r-total-idle-hours" value="0" />
										 {% endif %}
									    {% endif %}
									{% endif %}
								    {% endfor %}
									{% if data.value > 0 %}
										<span class="t-hours">{{ data.value }}</span>H
									{% else %}
										<span class="t-hours">0</span>H
									{% endif %}
									{{ data }}
								{% endif %}
							{% endfor %}
						</a>
					</td>
				{% elif data.label == 'Feedback' %}
			       		<td>
						{% if  data.value == None or data.value == '' %}	
						<button type="button" class="btn btn-default" disabled='disabled'>
						{% else %}
						{% with apIdT="#myModal-"|add:data.id_for_label %}
							{% for data in form.visible_fields %}
								{% if 'hold' in data.label %}
									{% if data.value %}
										<button type="button" class="btn btn-default disabled" data-toggle="modal" data-target={{ apIdT }}>
									{% else %}
										<button type="button" class="btn btn-default" data-toggle="modal" data-target={{ apIdT }}>
									{% endif %}
								{% endif %}
							{% endfor %}
						{% endwith %}
						{% endif %}
							<span class="glyphicon glyphicon-comment"></span>
						</button>
						{% with apId="myModal-"|add:data.id_for_label %}
						<div class="modal fade" id={{ apId }} tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-header">
											<b>Your Feedback</b>
										</div>
										<div class="modal-body">
											{{ data.value }}
										</div>
									</div>
								</div>
							</div>
						{% endwith %}	
					</td>
				{% elif 'Questions' not in data.label and 'Hours' not in data.label and 'id' not in data.label and 'Feedback' not in data.label and 'approved' not in data.label and 'hold' not in data.label %}
					{% if 'Project' in data.label or 'Location' in data.label or 'Chapter' in data.label or 'Task' in data.label  or 'Delete' in data.label %}
					{% for holdData in form.visible_fields %}
						{% if 'hold' in holdData.label or 'approved' in data.label %}
							{% if holdData.value %}
								<td class="ansr-disabled">{{ data }}</td>
							{% else %}		
								<td>{{ data }}</td>
							{% endif %}
						{% endif %}	
					{% endfor %}
					{% endif %}
                		{% endif %}
            		{% endspaceless %}
			{% endfor %}
		</tr>
		{% if forloop.last %}
		</tbody>
		{% endif %}
	{% endfor %}
	</table>
    </div>
    <div id="timesheet-non-billable">
	<legend>
	Non - Project Effort
	<span class="pull-right">
		<a type="submit" value="submit" id="timesheet-non-billable-add-btn" class="btn btn-success btn-xs">
			<span class="glyphicon glyphicon-plus"></span>
			Add Non-project effort Item
		</a>
	</span>
	</legend>
	{{ atFormset.management_form }}
	{% for eachError in atErrorList %}
		{% if eachError.items|length > 0 %}
			<div class="alert alert-danger" role="alert">
				{% for k, v in eachError.items %}
					{{ k }} : {{ v|striptags }}
				{% endfor %}
			</div>
		{% endif %}
	{% endfor %}
	<table class="table table-condensed table-responsive">
	{% for form in atFormset %}
		{{ form.errors }}
		{% if forloop.first %}
		<thead>
            	<tr>
		{% for field in form.hidden_fields %}
			{% if 'id' in field.label %}
				<td style="display: none">{{ field.label }}</td>
			{% endif %}
		{% endfor %}
                {% for data in form %}
		    {% if 'id' not in data.label and 'approved' not in data.label and 'hold' not in data.label %}
		    {% if forloop.counter == 1 or forloop.counter == 9 %}
		    	<th class="res-14-per">
		    {% else %}
			<th>
		    {% endif %}
                    	{{ data.label }}
                    {% if data.field.required %}
                        <span class="required">*</span>
		    {% endif %}
                    </th>
                    {% endif %}
                {% endfor %}
            	</tr>
		</thead>
		<tbody>
		{% endif %}
		<tr>
			{% for field in form.hidden_fields %}
				{% if 'id' in field.label %}
					<td style="display: none">{{ field }}</td>
				{% endif %}
			{% endfor %}
			{% for data in form %}
		    		{% if 'id' not in data.label and 'Feedback' not in data.label and 'approved' not in data.label and 'hold' not in data.label %}
					{% if 'Activity' in data.label or 'Mon' in data.label or 'Tue' in data.label or 'Wed' in data.label  or 'Thu' in data.label or 'Fri' in data.label or 'Sat' in data.label or 'Sun' in data.label or 'Total' in data.label or 'Delete' in data.label  %}
					{% for holdData in form.visible_fields %}
						{% if 'hold' in holdData.label %}
							{% if holdData.value %}
								<td class="ansr-disabled">{{ data }}</td>
							{% else %}		
								<td>{{ data }}</td>
							{% endif %}
						{% endif %}	
					{% endfor %}
					{% endif %}
				{% elif 'Feedback' in data.label %}
			       		<td>
						{% if  data.value == None or data.value == '' %}	
						<button type="button" class="btn btn-default" disabled='disabled'>
						{% else %}
						{% with apIdT="#actModal-"|add:data.id_for_label %}
							{% for data in form.visible_fields %}
								{% if 'hold' in data.label %}
									{% if data.value %}
										<button type="button" class="btn btn-default disabled" data-toggle="modal" data-target={{ apIdT }}>
									{% else %}
										<button type="button" class="btn btn-default" data-toggle="modal" data-target={{ apIdT }}>
									{% endif %}
								{% endif %}
							{% endfor %}
						{% endwith %}
						{% endif %}
							<span class="glyphicon glyphicon-comment"></span>
						</button>
						{% with apId="actModal-"|add:data.id_for_label %}
							<div class="modal fade" id={{ apId }} tabindex="-1" role="dialog" aria-labelledby="actModalLabel" aria-hidden="true">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-header">
											<b>Your Feedback</b>
										</div>
										<div class="modal-body">
											{{ data.value }}
										</div>
									</div>
								</div>
							</div>	
						{% endwith %}
					</td>
				{% endif %}
			{% endfor %}
		</tr>
		{% if forloop.last %}
		</tbody>
		{% endif %}
	{% endfor %}
	</table>
    </div>
    <div class="row">
        <div class="col-md-4 pull-right">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>Description</th>
                    <th>Hours</th>
                </tr>
                </thead>
                <tbody>
                <tr>
		    <td>Project Billable</td>
		    <td class="total-billable-hours">{{ bTotal }}</td>
                </tr>
                <tr>
                    <td>Project Idle</td>
		    <td class="total-idle-hours">{{ idleTotal }}</td>
                </tr>
                <tr>
                    <td>Others</td>
		    <td class="total-non-billable-hours">{{ othersTotal }}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <input type="hidden" name="startdate" value="{{ weekstartDate|date:"dmY" }}" />
    <input type="hidden" name="enddate" value="{{ weekendDate|date:"dmY" }}" />
    	<button type="submit" value="save" name="save" class="btn btn-info">Save Timesheet</button>
    	<a id="submitTS" value="submit" name="submit" class="btn btn-info pull-right">Submit Timesheet</a>
	<script>
 		$(document).on("click", "#submitTS", function(e) {		
			bootbox.confirm("Once submitted, your timesheet will be approved by the system and cannot be modified. If you wanted to save for now and change it later, please click cancel and press the save button. Otherwise please click OK", function(result) {
				if (result)
					$("#timesheet").submit();		
			});			
		});			
	</script>
 </button>
 </form>
{% endblock %}
